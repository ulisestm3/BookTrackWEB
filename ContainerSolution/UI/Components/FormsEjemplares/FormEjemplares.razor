@page "/CatEjemplares"
@layout MainLayout
@rendermode InteractiveServer
@inject NavigationManager NM
@inject DialogService DialogService

@inject IRadzenMessages RadzenMessages
@inject ISHA256 SHA
@inject IGeneral GRAL
@inject IPasswordUtility PasswordUtility
@inject IAutenticationsServices AutenticationServices
@inject IAuthenticationController AuthenticationController

@inject IvUsuariosController vUsuariosController
@inject IUsuariosController UsuariosController
@inject IEjemplaresController EjemplaresController
@inject IPrestamosController PrestamosController


<style>
    .titulo-azul {
        color: darkblue !important;
        text-align: center;
    }
</style>


@if (isAuthenticated)
{

    <h2 class="titulo-azul">ADMINISTRACIÓN DE EJEMPLARES</h2>

    <RadzenDataGrid Data="EjemplaresData"
                    TItem="vEjemplares"
                    AllowFiltering="true"
                    AllowPaging="true"
                    AllowSorting="true"
                    AllowColumnResize="true"
                    ColumnWidth="150px"
                    Density="Density.Default"
                    PageSize="10"
                    Responsive="true"
                    EditMode="DataGridEditMode.Single"
                    EmptyText="Sin registros para mostrar"
                    ShowPagingSummary="true"
                    PageSizeOptions=@PageSizeOptions
                    PagingSummaryFormat=@PagingSummaryFormat
                    PageSizeText="Registros por página"
                    ClearFilterText="Borrar"
                    ApplyFilterText="Aplicar"
                    FilterText="Filtro"
                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    FilterMode="FilterMode.Simple">

        <HeaderTemplate>
            <RadzenButton ButtonStyle="ButtonStyle.Success"
                          Disabled="!(Insert)"
                          Icon="add_circle"
                          Text="Agregar"
                          Click="@(() => NM.NavigateTo("/Ejemplares/nuevo"))" />
        </HeaderTemplate>

        <Columns>
            <RadzenDataGridColumn Property="@nameof(vEjemplares.EjemplarId)" Title="ID" Visible=false SortOrder="SortOrder.Descending" />

            <RadzenDataGridColumn TItem="vEjemplares" Property="CodigoBarra" Title="Código de Barra" />
            <RadzenDataGridColumn TItem="vEjemplares" Property="ISBN" Title="ISBN" />
            <RadzenDataGridColumn TItem="vEjemplares" Property="TituloLibro" Title="Título" />
            <RadzenDataGridColumn TItem="vEjemplares" Property="Autor" Title="Autor" />
            <RadzenDataGridColumn TItem="vEjemplares" Property="EstadoLibro" Title="Estado" />
            <RadzenDataGridColumn TItem="vEjemplares" Property="FechaAdquisicion" Title="Fecha Adquirido" />
            <RadzenDataGridColumn TItem="vEjemplares" Property="AnioPublicacion" Title="Año Publicación" />

            <RadzenDataGridColumn TItem="vEjemplares" Title="Acciones" Width="200px" Frozen="true" FrozenPosition="FrozenColumnPosition.Left">
                <Template Context="Ejemplares">
                    <RadzenButton Text=""
                                  Icon="edit"
                                  Size="ButtonSize.Small"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Disabled="!(Update)"
                                  Click="@(a => NM.NavigateTo($"/Ejemplares/{Ejemplares.EjemplarId}"))"
                                  @onclick:stopPropagation="true"
                                  Style="margin-right: 5px;" />

                    <RadzenButton Text=""
                                  Icon="delete"
                                  Size="ButtonSize.Small"
                                  ButtonStyle="ButtonStyle.Danger"
                                  Disabled="!(Delete)"
                                  Click="@(async () => await BorrarEjemplar(Ejemplares))"
                                  @onclick:stopPropagation="true" />

                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}
else
{
    if (!IsAuthorizedForm)
    {
        <NoAuthorized />
    }
    else
    {
        <div style="text-align: center; margin-top: 50px;">
            <h1>Validando Sesión...</h1>
            <div class="loading-spinner"></div>
        </div>
    }
}
<RadzenDialog />


@code {

    private List<vEjemplares> EjemplaresData = new();
    protected IEnumerable<int> PageSizeOptions { get; set; } = new[] { 2, 5, 10, 100 };
    protected string PagingSummaryFormat { get; set; } = "Página {0} de {1} (Total {2} Registros)";

    public string PasswordTemporal { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadGrid();
    }
    private async Task LoadGrid()
    {
        EjemplaresData = await EjemplaresController.vEjemplaresLista();
        StateHasChanged();
    }

    private async Task BorrarEjemplar(vEjemplares Ejemplar)
    {
        var PrestamoAsociados = await PrestamosController.ExistePrestamoPendienteEjemplar(Ejemplar.EjemplarId);
        if (PrestamoAsociados)
        {
            await RadzenMessages.ShowAlert(DialogService,
                "Este ejemplar no puede eliminarse porque tiene prestamos asociados.",
                eIcon.error);

            return;
        }

        var confirm = await RadzenMessages.ConfirmAsync(
            DialogService,
            "¿Está seguro de eliminar este Ejemplar?",
            "Confirmación"
        );

        if (confirm != true)
        {
            await RadzenMessages.ShowAlert(DialogService, "Operación cancelada.", eIcon.info);
            return;
        }

        await RefreshAuthenticationState();
        var user = await AutenticationServices.GetAuthenticated();
        if (user == null || user.IdUsuario <= 0)
        {
            await RadzenMessages.ShowAlert(DialogService, "Sesión no válida. Inicie sesión nuevamente.", eIcon.error);
            return;
        }

        var entidad = await EjemplaresController.Registro(Ejemplar.EjemplarId);
        entidad.UsuarioActualiza = user.IdUsuario;
        entidad.FechaActualizacion = DateTime.Now;

        bool resultado = await EjemplaresController.Anular(entidad);

        if (!resultado)
        {
            await RadzenMessages.ShowAlert(DialogService, "No se pudo eliminar el Ejemplar.", eIcon.error);
            return;
        }

        await RadzenMessages.ShowAlert(DialogService, "Ejemplar eliminado correctamente.", eIcon.success);
        await LoadGrid();
    }

}

<!-- #Seguridad -->
@code {
    public bool Insert { get; set; }
    public bool Update { get; set; }
    public bool Delete { get; set; }
    private byte IdFormulario = (byte)eFormularios.CatEjemplares;//Cambiar formulario según Corresponda
    private bool isAuthenticated = false;
    private bool isRefreshing = false;
    private bool IsAuthorizedForm = true;
    private List<vPermisosUsuario> VPermisosUsuario = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || !isAuthenticated)
        {
            await RefreshAuthenticationState();
        }
    }
    private async Task RefreshAuthenticationState()
    {
        if (!isRefreshing)
        {
            isRefreshing = true;
            try
            {
                isAuthenticated = await AutenticationServices.IsAuthenticated();

                if (isAuthenticated)
                {
                    await AutenticationServices.ExtendSession();
                    var result = await AutenticationServices.GetAuthenticated();
                    IsAuthorizedForm = await AuthenticationController.AutorizedForm(IdFormulario, result.IdUsuario);
                    isAuthenticated = IsAuthorizedForm;
                    VPermisosUsuario = await AuthenticationController.GetPermisosUsuario(result.IdUsuario, IdFormulario);
                    UploadPermission();
                    StateHasChanged();
                }
                else
                {
                    await ShowLogin();
                }
            }
            finally
            {
                isRefreshing = false;
            }
        }
    }
    public string Login { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
    private async Task ShowLogin()
    {
        var parameter = new Dictionary<string, object>();
        //parameter.Add("Id", Id);
        //parameter["type"] = type;

        var dialogOption = new DialogOptions();
        dialogOption.ShowClose = false;
        dialogOption.CloseDialogOnEsc = false;
        dialogOption.CloseDialogOnOverlayClick = false;
        dialogOption.Resizable = false;
        dialogOption.ShowTitle = true;

        await DialogService.OpenAsync<SessionExpired.LoginRequired>("INICIAR SESIÓN", parameter, dialogOption);
        StateHasChanged();
    }

    private void UploadPermission()
    {
        Insert = VPermisosUsuario.Where(a => a.IdPermiso == (byte)ePermiso.Agregar).Count() > 0;
        Update = VPermisosUsuario.Where(a => a.IdPermiso == (byte)ePermiso.Actualizar).Count() > 0;
        Delete = VPermisosUsuario.Where(a => a.IdPermiso == (byte)ePermiso.Anular).Count() > 0;
    }
}
<!-- #endregion -->